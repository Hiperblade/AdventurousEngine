<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="js/animatronic.js"></script>
    <script type="text/javascript" src="js/animatronicsController.js"></script>
    <script type="text/javascript" src="js/engine.js"></script>
	<style TYPE="text/css">
		.actor
		{
			position: absolute;
			top: 100px;
			left: 100px;
			width: 81px;
			height: 48px;
		}

		.fish
		{
			position: absolute;
			top: 150px;
			left: 250px;

            /* */
			width: 71px;
			height: 60px;
            /* */
            /* background-color: red; */
		}

		.scene
		{
			position: absolute;
			top: 0px;
			left: 0px;
			width: 540px;
			height: 338px;
		}

		.controlPanel
		{
			position: absolute;
			top: 350px;
			left: 0px;
		}

		#frontClass
		{
			opacity: 0.9;
		}
	</style>
</head>
<body>
	<!-- ------------- -->

<div id="screen" class="scene">
	<svg class="scene" xmlns="http://www.w3.org/2000/svg" width="300" height="300">
		<g id="backClass">
			<image width="540" height="338" xlink:href="scenes/scene.jpg"></image>
		</g>
	</svg>
	<div class="scene" id="area_1">
        <!--img class="fish" src="./Fish/Fish.gif"-->
        <canvas id="Pesce" class="fish"></canvas>
	</div>
	<svg class="scene" xmlns="http://www.w3.org/2000/svg" width="300" height="300">
		<use id="frontClass" xlink:href="#backClass" clip-path="url(#clipArea)"></use>
		<defs>
			<clipPath id="clipArea">
				<path d="m 192.54091,219.49886 8.20051,0 -1.36675,4.2711 -4.78363,5.63784 -3.58771,1.5376 -0.51254,-4.44194 0.17084,-5.12532 z m -19.64703,0 13.15497,-0.17084 -3.9294,13.15497 -4.95447,14.18003 -4.44194,-1.02506 -5.467,-5.29616 -0.51253,-7.51713 3.41687,-6.15037 z m -12.47159,1.02507 7.17544,0 -0.68338,4.10025 -3.24603,6.15037 -2.22097,-3.41687 -1.02506,-4.10026 z M 0.375,95.75 l 0,242.25 116.5,0.0625 0,0.0937 55.625,-0.0625 141.65625,0.0937 0.3125,-0.21875 225.5625,-0.21875 0.25,-146.3125 -5.15625,0.0625 1.96875,-9 -5.3125,-2.84375 -9.96875,1.9375 -18.40625,12.375 -5.59375,6.125 -3.15625,-5.28125 -5.15625,-3.1875 -5.1875,4.9375 -6.25,9.625 -4.53125,9.75 -2.78125,13.34375 -16.40625,8.8125 -6.53125,-22.46875 -4.84375,-13.15625 -2.6875,-5.25 -3.84375,-2.96875 -5.03125,15.1875 -2.875,22.59375 -3.03125,23.3125 -6.5625,3.5625 L 416.53125,248 l -6.375,-14.5 -4.28125,-2.8125 -6.25,12.4375 -1.6875,15.28125 -0.71875,15.625 -23.4375,15.5625 -19.59375,-9.1875 -18.84375,-7.96875 -32.375,-9.1875 -3.34375,-0.71875 -0.625,-1.125 3.03125,-8.0625 -0.5,-29.3125 L 297.5,209.375 l -2.53125,-9.0625 -8.59375,0 -8.59375,5.03125 -9.09375,9.59375 -10.59375,16.6875 -1,5.53125 -4.0625,14.65625 -0.625,1.09375 -65.65625,-4.53125 4.6875,-6.65625 11.59375,-13.65625 2.03125,-7.5625 10.59375,-1 5.0625,-5.5625 16.15625,-68.6875 -2.53125,-6.0625 2.53125,-3.03125 -3.03125,-13.625 -7.5625,-10.125 -12.125,-2 -12.125,6.5625 -24.75,19.1875 -13.125,15.65625 -8.09375,12.625 -7.5625,19.1875 -13.125,39.90625 18.6875,-1 2,15.15625 5.0625,10.59375 2.9375,4.3125 -14.25,2.9375 -15,2.90625 -15.09375,8.28125 -4.0625,-12.375 L 94.4375,221.5 76.78125,177.0625 33.84375,137.65625 0.375,95.75 z"></path>
			</clipPath>
		</defs>
	</svg>
</div>


<br/>

    <script>
        function Actor(canvasId, frameWidth, frameHeight, spriteImage, animations, loadCallback)
        {
            var _context;
            var _image;
            var _framePerRow = 0;
            var _width;
            var _height;
            var _animations = animations;

            var _currentAnimation = null;
            var _nextAnimation = null;
            var _currentFrame = 0;
            var _repeatCount = -1;
            var _beginCallback = null;
            var _endCallback = null;

            var _initialize = function(canvasId, frameWidth, frameHeight, spriteImage, loadCallback)
            {
                _width = frameWidth;
                _height = frameHeight;

                var canvas = $("#" + canvasId)[0];
                canvas.width = _width;
                canvas.height = _height;
                _context = canvas.getContext('2d');

                // load image
                var image = $('<img src="'+ spriteImage +'" style="display:none;">');
                image.load(function()
                {
                    _framePerRow = Math.floor(this.width / _width);
                    if(loadCallback)
                    {
                        loadCallback();
                    }
                });
                _image = image[0]; // get the html tag
            };

            var _setFrame = function(frame)
            {
                var x = frame % _framePerRow;
                var y = Math.floor(frame / _framePerRow);
                _context.clearRect(0, 0, _width, _height);
                _context.drawImage(_image, x * _width, y * _height, _width, _height, 0, 0, _width, _height);
            };

            var _nextFrame = function()
            {
                if(_currentAnimation)
                {
                    if(_currentFrame == 0)
                    {
                        if(_beginCallback != null)
                        {
                            _beginCallback(this);
                        }
                    }

                    _setFrame(_animations[_currentAnimation][_currentFrame]);
                    _currentFrame++;

                    if(_currentFrame >= _animations[_currentAnimation].length)
                    {
                        _currentFrame = 0;
                        // animazione terminata
                        if(_repeatCount == -1)
                        {
                            // loop
                            if(_nextAnimation)
                            {
                                _currentAnimation = null;

                                if(_endCallback != null)
                                {
                                    _endCallback(this);
                                }

                                _startAnimation(_nextAnimation.name, _nextAnimation.beginCallback, _nextAnimation.endCallback, _nextAnimation.repeatCount);
                                _nextAnimation = null;
                            }
                        }
                        else
                        {
                            _repeatCount--;
                            if(_repeatCount <= 0)
                            {
                                _currentAnimation = null;

                                if(_endCallback != null)
                                {
                                    _endCallback(this);
                                }

                                if(_nextAnimation)
                                {
                                    _startAnimation(_nextAnimation.name, _nextAnimation.beginCallback, _nextAnimation.endCallback, _nextAnimation.repeatCount);
                                    _nextAnimation = null;
                                }
                            }
                        }
                    }
                }
            };

            var _setNextAnimationLoop = function (name, beginCallback, endCallback)
            {
                _setNextAnimation(name, beginCallback, endCallback, -1);
            };

            var _setNextAnimation = function (name, beginCallback, endCallback, repeatCount)
            {
                if(repeatCount == null)
                {
                    repeatCount = 1;
                }

                if(_currentAnimation == null)
                {
                    _startAnimation(name, beginCallback, endCallback, repeatCount);
                }
                else
                {
                    _nextAnimation = {"name": name, "beginCallback": beginCallback, "endCallback": endCallback, "repeatCount": repeatCount};
                }
            };

            var _setAnimationLoop = function (name, beginCallback, endCallback)
            {
                _setAnimation(name, beginCallback, endCallback, -1);
            };

            var _setAnimation = function (name, beginCallback, endCallback, repeatCount)
            {
                if(repeatCount == null)
                {
                    repeatCount = 1;
                }

                //TODO: lanciare l'evento di fine animazione precedente anche se non Ã¨ stata completata?

                _nextAnimation = null;

                _startAnimation(name, beginCallback, endCallback, repeatCount);
            };

            var _startAnimation = function(name, beginCallback, endCallback, repeatCount)
            {
                _beginCallback = beginCallback;
                _endCallback = endCallback;
                _repeatCount = repeatCount;
                _currentFrame = 0;
                _currentAnimation = name;
            };

            /* *************************************** */

            this.nextFrame = _nextFrame;
            this.setNextAnimation = _setNextAnimation;
            this.setNextAnimationLoop = _setNextAnimationLoop;
            this.setAnimation = _setAnimation;
            this.setAnimationLoop = _setAnimationLoop;

            /* *************************************** */

            _initialize(canvasId, frameWidth, frameHeight, spriteImage, loadCallback);
        }


        var pesciolino = new Actor("Pesce", 71, 60, "Fish/Fish.png", {
            "jump": [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22],
            "test": [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1]
        });




        window.setInterval("nextStep();", 100);

        function go()
        {
            //window.setInterval("nextStep();", 100);
            pesciolino.setAnimationLoop("jump");
            pesciolino.setNextAnimation("test");
        }

        function nextStep()
        {
            pesciolino.nextFrame();
        }
    </script>

	<div class="controlPanel">
		<button onclick="go();">Test</button>
	</div>

    <!--img id="fishImage" src="Fish/Fish.png" style="width: 355px; height: 300px; visibility: hidden;"-->
    <!--img id="fishImage" src="Fish/Fish.png"-->
    <!--img id="fishImage" src="http://www.williammalone.com/briefs/how-to-draw-image-html5-canvas/images/watermelon-duck.png"-->

</body>
</html>