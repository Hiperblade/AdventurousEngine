<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="js/actor.js"></script>
    <script type="text/javascript" src="js/director.js"></script>
    <script type="text/javascript" src="js/engine.js"></script>
	<style TYPE="text/css">
		.actor
		{
			position: absolute;
			top: 100px;
			left: 100px;
			width: 81px;
			height: 48px;
		}

        .actor2
        {
            position: absolute;
            top: 80px;
            left: 80px;
            width: 81px;
            height: 48px;
        }

		.fish
		{
			position: absolute;
			top: 150px;
			left: 250px;
			width: 71px;
			height: 60px;
		}

		.scene
		{
			position: absolute;
			top: 0px;
			left: 0px;
			width: 540px;
			height: 338px;
		}

		.controlPanel
		{
			position: absolute;
			top: 350px;
			left: 0px;
		}

		#frontClass
		{
			opacity: 0.9;
		}
	</style>
</head>
<body>
	<!-- ------------- -->

<div id="screen" class="scene" onclick="goTo()">
	<svg class="scene" xmlns="http://www.w3.org/2000/svg" width="300" height="300">
		<g id="backClass">
			<image width="540" height="338" xlink:href="scenes/scene.jpg"></image>
		</g>
	</svg>

    <!--svg id="walkingArea" class="scene" xmlns="http://www.w3.org/2000/svg" width="300" height="300">
        <path style="fill:#FFFFFF; stroke:none;"
              d="m 0.50507627,95.747722 91.92388173,0.505076 55.053312,1.515229 67.17515,7.071063 68.69037,10.60661 31.8198,7.07106 24.24367,9.59645 15.65736,10.60661 -8.08122,4.54568 -52.52793,6.56599 13.63706,8.5863 c 0,0 -5.55584,3.53553 -9.59645,3.53553 -4.04061,0 -34.34519,-0.50507 -34.34519,-0.50507 l -12.12183,8.08122 c 0,0 -16.66752,5.55584 -18.68782,6.06091 -2.02031,0.50508 -54.54824,11.61676 -54.54824,11.61676 l -57.57869,13.63706 -35.86042,1.51523 -85.35789,0 0,-3.03046 z"></path>
    </svg-->

    <div class="scene" id="area_0">
    </div>

	<div class="scene" id="area_1">
        <canvas id="Pesce" class="fish"></canvas>
        <canvas id="Gatto2" class="actor2"></canvas>
        <canvas id="Gatto" class="actor"></canvas>
	</div>
	<!--svg class="scene" xmlns="http://www.w3.org/2000/svg" width="300" height="300">
		<use id="frontClass" xlink:href="#backClass" clip-path="url(#clipArea)"></use>
		<defs>
			<clipPath id="clipArea">
				<path d="m 192.54091,219.49886 8.20051,0 -1.36675,4.2711 -4.78363,5.63784 -3.58771,1.5376 -0.51254,-4.44194 0.17084,-5.12532 z m -19.64703,0 13.15497,-0.17084 -3.9294,13.15497 -4.95447,14.18003 -4.44194,-1.02506 -5.467,-5.29616 -0.51253,-7.51713 3.41687,-6.15037 z m -12.47159,1.02507 7.17544,0 -0.68338,4.10025 -3.24603,6.15037 -2.22097,-3.41687 -1.02506,-4.10026 z M 0.375,95.75 l 0,242.25 116.5,0.0625 0,0.0937 55.625,-0.0625 141.65625,0.0937 0.3125,-0.21875 225.5625,-0.21875 0.25,-146.3125 -5.15625,0.0625 1.96875,-9 -5.3125,-2.84375 -9.96875,1.9375 -18.40625,12.375 -5.59375,6.125 -3.15625,-5.28125 -5.15625,-3.1875 -5.1875,4.9375 -6.25,9.625 -4.53125,9.75 -2.78125,13.34375 -16.40625,8.8125 -6.53125,-22.46875 -4.84375,-13.15625 -2.6875,-5.25 -3.84375,-2.96875 -5.03125,15.1875 -2.875,22.59375 -3.03125,23.3125 -6.5625,3.5625 L 416.53125,248 l -6.375,-14.5 -4.28125,-2.8125 -6.25,12.4375 -1.6875,15.28125 -0.71875,15.625 -23.4375,15.5625 -19.59375,-9.1875 -18.84375,-7.96875 -32.375,-9.1875 -3.34375,-0.71875 -0.625,-1.125 3.03125,-8.0625 -0.5,-29.3125 L 297.5,209.375 l -2.53125,-9.0625 -8.59375,0 -8.59375,5.03125 -9.09375,9.59375 -10.59375,16.6875 -1,5.53125 -4.0625,14.65625 -0.625,1.09375 -65.65625,-4.53125 4.6875,-6.65625 11.59375,-13.65625 2.03125,-7.5625 10.59375,-1 5.0625,-5.5625 16.15625,-68.6875 -2.53125,-6.0625 2.53125,-3.03125 -3.03125,-13.625 -7.5625,-10.125 -12.125,-2 -12.125,6.5625 -24.75,19.1875 -13.125,15.65625 -8.09375,12.625 -7.5625,19.1875 -13.125,39.90625 18.6875,-1 2,15.15625 5.0625,10.59375 2.9375,4.3125 -14.25,2.9375 -15,2.90625 -15.09375,8.28125 -4.0625,-12.375 L 94.4375,221.5 76.78125,177.0625 33.84375,137.65625 0.375,95.75 z"></path>
			</clipPath>
		</defs>
	</svg-->

	<!--svg class="scene" id="walker" xmlns="http://www.w3.org/2000/svg" width="300" height="300"><path d="m 0.50507627,95.747722 91.92388173,0.505076 55.053312,1.515229 67.17515,7.071063 68.69037,10.60661 31.8198,7.07106 24.24367,9.59645 15.65736,10.60661 -8.08122,4.54568 -52.52793,6.56599 13.63706,8.5863 c 0,0 -5.55584,3.53553 -9.59645,3.53553 -4.04061,0 -34.34519,-0.50507 -34.34519,-0.50507 l -12.12183,8.08122 c 0,0 -16.66752,5.55584 -18.68782,6.06091 -2.02031,0.50508 -54.54824,11.61676 -54.54824,11.61676 l -57.57869,13.63706 -35.86042,1.51523 -85.35789,0 0,-3.03046 z"></path></svg-->
	<!--svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><path style="fill:#000000; stroke:none;" d="m 0.50507627,95.747722 91.92388173,0.505076 55.053312,1.515229 67.17515,7.071063 68.69037,10.60661 31.8198,7.07106 24.24367,9.59645 15.65736,10.60661 -8.08122,4.54568 -52.52793,6.56599 13.63706,8.5863 c 0,0 -5.55584,3.53553 -9.59645,3.53553 -4.04061,0 -34.34519,-0.50507 -34.34519,-0.50507 l -12.12183,8.08122 c 0,0 -16.66752,5.55584 -18.68782,6.06091 -2.02031,0.50508 -54.54824,11.61676 -54.54824,11.61676 l -57.57869,13.63706 -35.86042,1.51523 -85.35789,0 0,-3.03046 z"></path></svg-->

</div>

<br/>
    <script>
        var suits = {
            "fish": { width: 71, height: 60, sprite: "sprites/Fish.png", animations: {
                "go": [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23]
            }, loadCallback: null },

            "cat": { width: 81, height: 48, sprite: "sprites/Cat.png", animations: {
                "Down": [0],
                "runDown": [1, 2, 3, 4, 5],
                "Left": [6],
                "runLeft": [7, 8, 9, 10, 11],
                "Right": [12],
                "runRight": [13, 14, 15, 16, 17],
                "Up": [18],
                "runUp": [19, 20, 21, 22, 23],
                "stand": [24, 24, 25, 25, 26, 26, 27, 27, 28, 28, 29, 29, 30, 30],
                "miao": [31, 32, 32, 33, 33, 33, 33, 31]
            }, loadCallback: null }
        };

        //------------------------------

        var director = new Director( function(){ moveActor(); } );

        director.addActor("Pesce", suits["fish"]);
        director.addActor("Gatto", suits["cat"]);
        director.addActor("Gatto2", suits["cat"]);

        var pesciolino = director.getActor("Pesce");
        var gattino = director.getActor("Gatto");
        var gattaccio = director.getActor("Gatto2");

        var Direction = { Up: 'Up', Down: 'Down', Left: 'Left', Right: 'Right' };

        function go()
        {
            pesciolino.setNextAnimation("go", null, function(){ gattino.setAnimation("miao"); gattino.setNextAnimationLoop("stand"); } );

            gattaccio.setAnimationLoop("runLeft");
        }

        gattino.setAnimationLoop("stand");

        // --------------------------------------------------

        function moveActor()
        {
            var actor = gattino;

            if(targetLocation != null)
            {
                var pos = actor.getPosition();
                var deltaL = targetLocation.x - pos.x;
                var deltaT = targetLocation.y - pos.y;
                if(Math.abs(deltaL) < 5)
                    deltaL = 0;
                if(Math.abs(deltaT) < 5)
                    deltaT = 0;

                if(deltaL != 0 || deltaT != 0)
                {
                    var dirL;
                    if(deltaL == 0)
                        dirL = null;
                    else if(deltaL > 0)
                        dirL = Direction.Right;
                    else
                        dirL = Direction.Left;

                    var dirT;
                    if(deltaT == 0)
                        dirT = null;
                    else if(deltaT > 0)
                        dirT = Direction.Down;
                    else
                        dirT = Direction.Up;

                    if(Math.abs(deltaL) >= Math.abs(deltaT))
                    {
                        setRunAnimationActor(dirL);
                        setPositionActor(actor, dirL, dirT);
                    }
                    else
                    {
                        setRunAnimationActor(dirT);
                        setPositionActor(actor, dirT, dirL);
                    }
                }
                else
                {
                    targetLocation = null;
                    currentRunDirection = null;
                    actor.setAnimationLoop("stand");
                }
            }
        }

        function setPositionActor(actor, dirP, dirS)
        {
            var x;
            var y;
            switch (dirP)
            {
                case Direction.Down:
                    y = 4;
                    break;
                case Direction.Up:
                    y = -4;
                    break;
                case Direction.Left:
                    x = -4;
                    break;
                case Direction.Right:
                    x = 4;
                    break;
            }
            switch (dirS)
            {
                case Direction.Down:
                    y = 1;
                    break;
                case Direction.Up:
                    y = -1;
                    break;
                case Direction.Left:
                    x = -1;
                    break;
                case Direction.Right:
                    x = 1;
                    break;
            }

            var pos = actor.getPosition();
            actor.setPosition(pos.x + x, pos.y + y);
        }

        var currentRunDirection = null;
        function setRunAnimationActor(dir)
        {
            if(currentRunDirection != dir)
            {
                currentRunDirection = dir;
                gattino.setAnimationLoop('run' + dir);
            }
        }

        var targetLocation = null;
        function goTo()
        {
            // base del gatto (44; 37)
			var destination = wa.findPoint({x: currentMousePos.x, y: currentMousePos.y })

            targetLocation = { x: destination.x - 44, y: destination.y - 37 };
        }

        var currentMousePos = { x: -1, y: -1 };
        $(document).mousemove(function(event) {
            currentMousePos.x = event.pageX;
            currentMousePos.y = event.pageY;
        });

		var pathString = "m 0.50507627,95.747722 91.92388173,0.505076 55.053312,1.515229 67.17515,7.071063 68.69037,10.60661 31.8198,7.07106 24.24367,9.59645 15.65736,10.60661 -8.08122,4.54568 -52.52793,6.56599 13.63706,8.5863 c 0,0 -5.55584,3.53553 -9.59645,3.53553 -4.04061,0 -34.34519,-0.50507 -34.34519,-0.50507 l -12.12183,8.08122 c 0,0 -16.66752,5.55584 -18.68782,6.06091 -2.02031,0.50508 -54.54824,11.61676 -54.54824,11.61676 l -57.57869,13.63706 -35.86042,1.51523 -85.35789,0 0,-3.03046 z";

		function WalkingArea(pathString, size)
		{
            var _canvas;
			var _ctx;
            var _size;

			var _initialize = function(pathString, size)
			{
                _size = size;
				_canvas = $('<canvas class="scene"></canvas>')[0];
				_canvas.width = size.x;
				_canvas.height = size.y;
				_ctx = _canvas.getContext("2d");
                var svg_xml = '<svg xmlns="http://www.w3.org/2000/svg" class="scene"><path d="' + pathString + '"></path></svg>';
//*
                var img = $('<img class="scene"/>');
                var tagImage = img[0];
                img.load(function()
                {
					_ctx.drawImage(tagImage, 0, 0, size.x, size.y, 0, 0, size.x, size.y);
                });
                img.attr('src', "data:image/svg+xml;base64," + btoa(svg_xml));
//*/
/*
				var img = new Image();
                //img.style.height = size.y + "px";
                //img.style.width = size.x + "px";
				img.onload = function()
                {
                    _ctx.drawImage(img, 0, 0);
                };
				img.src = "data:image/svg+xml;base64," + btoa(svg_xml);
//*/
                //$("#area_0").append(img);
                //$("#area_0").append($(svg_xml));
                $("#area_0").append(_canvas);
			};

			var _findPoint = function(destination)
			{
                if(_isValid(destination))
                {
                    return destination;
                }

                var SAMPLE = 5;

                var north = Math.floor(destination.y / SAMPLE);
                var west = Math.floor(destination.x / SAMPLE);
                var south = Math.floor((_size.y - destination.y) / SAMPLE);
                var east = Math.floor((_size.x - destination.x) / SAMPLE);
                var lastStep = Math.max(north, south, west, east);

                var newDestination;
                for(var step = 1; step <= lastStep; step++)
                {
                    var gap = step * SAMPLE;
                    if(step <= north)
                    {
                        newDestination = { x: destination.x, y: destination.y - gap };
                        if(_isValid(newDestination))
                        {
                            return newDestination;
                        }
                        if(step <= west)
                        {
                            newDestination = { x: destination.x - gap, y: destination.y - gap };
                            if(_isValid(newDestination))
                            {
                                return newDestination;
                            }
                        }
                        if(step <= east)
                        {
                            newDestination = { x: destination.x + gap, y: destination.y - gap };
                            if(_isValid(newDestination))
                            {
                                return newDestination;
                            }
                        }
                    }
                    if(step <= south)
                    {
                        newDestination = { x: destination.x, y: destination.y + gap };
                        if(_isValid(newDestination))
                        {
                            return newDestination;
                        }
                        if(step <= west)
                        {
                            newDestination = { x: destination.x - gap, y: destination.y + gap };
                            if(_isValid(newDestination))
                            {
                                return newDestination;
                            }
                        }
                        if(step <= east)
                        {
                            newDestination = { x: destination.x + gap, y: destination.y + gap };
                            if(_isValid(newDestination))
                            {
                                return newDestination;
                            }
                        }
                    }
                    if(step <= west)
                    {
                        newDestination = { x: destination.x - gap , y: destination.y };
                        if(_isValid(newDestination))
                        {
                            return newDestination;
                        }
                    }
                    if(step <= east)
                    {
                        newDestination = { x: destination.x + gap , y: destination.y };
                        if(_isValid(newDestination))
                        {
                            return newDestination;
                        }
                    }
                }

				return null;
			};

			var _isValid = function(point)
			{
				return _ctx.getImageData(Math.floor(point.x), Math.floor(point.y), 1, 1).data[3] > 0;
			};

            /*
			var _getDistance = function(pointA, pointB)
			{
				return Math.sqrt(Math.pow(pointA.x - pointB.x, 2) + Math.pow(pointA.y - pointB.y, 2));
			};
            */

            /*
			var _getIntersection = function(point, pointA, pointB)
			{
				var m = (pointB.y - pointA.y)/(pointB.x - pointA.x);
				var x = (point.x + (m * point.y)) / (Math.pow(m, 2) + 1);
				return { x: x, y: (m * x) };
			};
            */

			this.findPoint = _findPoint;

			_initialize(pathString, size);
		}

		var wa = new WalkingArea(pathString, { x: 540, y: 338 });
	</script>

	<div class="controlPanel">
		<button onclick="go();">Test</button>
	</div>
</body>
</html>